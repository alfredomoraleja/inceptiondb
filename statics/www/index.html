<!doctype html>
<html lang="es">
  <head>
    <meta charset="utf-8">
    <title>InceptionDB Console</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0">
    <link rel="stylesheet" href="/lib/tailwind.min.css">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><circle cx='50' cy='50' r='48' fill='%230f172a'/><text x='50' y='58' font-size='52' text-anchor='middle' fill='white'>IDB</text></svg>">
    <script src="/lib/axios.min.js"></script>
    <script src="/lib/vue.global.prod.js"></script>
  </head>
  <body class="bg-slate-950 text-slate-100 min-h-screen">
    <div id="app" class="min-h-screen flex">
      <aside class="w-72 bg-slate-900 border-r border-slate-800 flex flex-col">
        <div class="px-6 py-5 border-b border-slate-800">
          <div class="flex items-center justify-between">
            <h1 class="text-xl font-semibold tracking-wide">InceptionDB</h1>
            <a
              class="text-slate-400 hover:text-slate-200"
              href="https://github.com/fulldump/inceptiondb"
              target="_blank"
              rel="noopener"
              aria-label="Repositorio en GitHub"
            >
              <svg class="w-6 h-6" viewBox="0 0 16 16" fill="currentColor" aria-hidden="true">
                <path
                  fill-rule="evenodd"
                  d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"
                  clip-rule="evenodd"
                />
              </svg>
            </a>
          </div>
          <button
            type="button"
            class="mt-5 w-full rounded-md border border-slate-700 px-3 py-2 text-sm font-medium text-slate-100 bg-slate-800 hover:bg-slate-700 transition"
            @click="toggleCreateForm"
          >
            {{ createForm.open ? 'Cancelar' : 'Nueva colección' }}
          </button>
          <form v-if="createForm.open" class="mt-4 space-y-3" @submit.prevent="createCollection">
            <div>
              <label for="new-collection" class="block text-xs uppercase tracking-wide text-slate-400">Nombre</label>
              <input
                id="new-collection"
                v-model="createForm.name"
                type="text"
                required
                class="mt-1 w-full rounded-md border border-slate-700 bg-slate-950 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-sky-500"
                placeholder="clientes"
              >
            </div>
            <button
              type="submit"
              class="w-full rounded-md bg-sky-600 hover:bg-sky-500 px-3 py-2 text-sm font-semibold text-white transition"
            >
              Crear colección
            </button>
            <p v-if="createForm.error" class="text-sm text-rose-400">{{ createForm.error }}</p>
          </form>
        </div>
        <div class="flex-1 overflow-y-auto">
          <div v-if="collectionsLoading" class="px-6 py-4 text-sm text-slate-400">Cargando colecciones…</div>
          <div v-else-if="collectionsError" class="px-6 py-4 text-sm text-rose-400">{{ collectionsError }}</div>
          <nav v-else class="py-2">
            <button
              v-for="collection in collections"
              :key="collection.name"
              type="button"
              class="w-full px-6 py-3 text-left hover:bg-slate-800 transition"
              :class="{
                'bg-slate-800 text-sky-300': isSelected(collection.name),
                'text-slate-200': !isSelected(collection.name)
              }"
              @click="selectCollection(collection.name)"
            >
              <div class="flex items-center justify-between text-sm font-medium">
                <span class="truncate">{{ collection.name }}</span>
                <span class="text-xs text-slate-400" v-if="collection.total !== undefined">{{ prettyTotal(collection.total) }}</span>
              </div>
              <p class="mt-1 text-xs text-slate-500" v-if="collection.indexes">{{ collection.indexes }} índices</p>
            </button>
            <p v-if="collections.length === 0" class="px-6 py-4 text-sm text-slate-500">No hay colecciones registradas.</p>
          </nav>
        </div>
      </aside>

      <main class="flex-1">
        <div v-if="!selectedCollection" class="flex h-full flex-col items-center justify-center text-center gap-3 px-6">
          <h2 class="text-2xl font-semibold text-slate-200">Bienvenido a InceptionDB</h2>
          <p class="text-slate-400 max-w-md">Selecciona o crea una colección en el panel lateral para comenzar a consultar, insertar o eliminar documentos.</p>
        </div>

        <div v-else class="flex flex-col gap-6 p-6">
          <header class="flex flex-col gap-3 md:flex-row md:items-center md:justify-between">
            <div>
              <h2 class="text-2xl font-semibold text-slate-100">Colección {{ selectedCollection.name }}</h2>
              <p class="text-sm text-slate-400 flex flex-wrap items-center gap-3">
                <span v-if="selectedCollection.total !== undefined">Total: {{ selectedCollection.total }}</span>
                <span v-if="queryStats.elapsed">Última consulta: {{ queryStats.elapsed }}</span>
                <span v-if="queryStats.returned">Documentos listados: {{ queryStats.returned }}</span>
              </p>
            </div>
            <div class="flex flex-wrap gap-2">
              <button
                type="button"
                class="rounded-md border border-slate-700 bg-slate-900 px-3 py-2 text-sm font-medium text-slate-200 hover:bg-slate-800 transition"
                @click="runQuery"
              >
                Ejecutar consulta
              </button>
              <button
                type="button"
                class="rounded-md border border-rose-500/40 bg-rose-600/20 px-3 py-2 text-sm font-medium text-rose-300 hover:bg-rose-600/30 transition"
                @click="dropCollection"
              >
                Eliminar colección
              </button>
            </div>
          </header>

          <section class="grid gap-6 lg:grid-cols-[2fr_1fr]">
            <div class="space-y-6">
              <div class="rounded-xl border border-slate-800 bg-slate-900/60 p-5 shadow-inner space-y-5">
                <div>
                  <label for="filter" class="block text-xs uppercase tracking-wide text-slate-400">Filtro (JSON)</label>
                  <textarea
                    id="filter"
                    v-model="filterText"
                    rows="4"
                    class="mt-2 w-full rounded-lg border border-slate-700 bg-slate-950 px-3 py-2 text-sm font-mono text-slate-200 focus:outline-none focus:ring-2 focus:ring-sky-500"
                    placeholder="{ }"
                  ></textarea>
                  <p v-if="filterError" class="mt-2 text-sm text-rose-400">{{ filterError }}</p>
                </div>

                <div class="flex flex-col gap-3 md:flex-row md:items-center md:justify-between">
                  <label class="block text-xs uppercase tracking-wide text-slate-400">
                    Elementos por página
                    <select
                      v-model.number="pageSize"
                      class="mt-1 w-full rounded-lg border border-slate-700 bg-slate-950 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-sky-500"
                    >
                      <option v-for="size in pageSizeOptions" :key="size" :value="size">{{ size }}</option>
                    </select>
                  </label>
                  <p class="text-xs text-slate-400 md:text-right">{{ pageInfo }}</p>
                </div>

                <div>
                  <label class="block text-xs uppercase tracking-wide text-slate-400">Índice</label>
                  <select
                    v-model="selectedIndexName"
                    class="mt-2 w-full rounded-lg border border-slate-700 bg-slate-950 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-sky-500"
                  >
                    <option value="">Sin índice (full scan)</option>
                    <option v-for="index in indexes" :key="index.name" :value="index.name">
                      {{ index.name }} · {{ index.type }}
                    </option>
                  </select>
                </div>

                <div v-if="activeIndex && activeIndex.type === 'map'" class="grid gap-2">
                  <label class="block text-xs uppercase tracking-wide text-slate-400">Valor del índice</label>
                  <input
                    type="text"
                    v-model="mapValue"
                    class="w-full rounded-lg border border-slate-700 bg-slate-950 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-sky-500"
                    placeholder="Introduce un valor único"
                  >
                </div>

                <div v-if="activeIndex && activeIndex.type === 'btree'" class="space-y-4">
                  <div>
                    <span class="block text-xs uppercase tracking-wide text-slate-400 mb-2">Desde (incluido)</span>
                    <div class="grid gap-3 md:grid-cols-2">
                      <label v-for="field in activeIndex.fields" :key="'from-' + field" class="text-sm text-slate-300">
                        <span class="block text-xs uppercase tracking-wide text-slate-500">{{ field }}</span>
                        <input
                          type="text"
                          v-model="rangeFrom[field]"
                          class="mt-1 w-full rounded-lg border border-slate-700 bg-slate-950 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-sky-500"
                        >
                      </label>
                    </div>
                  </div>
                  <div>
                    <span class="block text-xs uppercase tracking-wide text-slate-400 mb-2">Hasta (excluido)</span>
                    <div class="grid gap-3 md:grid-cols-2">
                      <label v-for="field in activeIndex.fields" :key="'to-' + field" class="text-sm text-slate-300">
                        <span class="block text-xs uppercase tracking-wide text-slate-500">{{ field }}</span>
                        <input
                          type="text"
                          v-model="rangeTo[field]"
                          class="mt-1 w-full rounded-lg border border-slate-700 bg-slate-950 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-sky-500"
                        >
                      </label>
                    </div>
                  </div>
                  <label class="inline-flex items-center gap-2 text-sm text-slate-300">
                    <input type="checkbox" v-model="reverse" class="h-4 w-4 rounded border-slate-700 bg-slate-900">
                    Orden inverso
                  </label>
                </div>

                <div class="flex flex-wrap justify-end gap-2">
                  <button
                    type="button"
                    class="rounded-md border border-slate-700 bg-slate-900 px-3 py-2 text-sm text-slate-200 hover:bg-slate-800 transition"
                    :disabled="disablePrev"
                    @click="prevPage"
                  >
                    Anterior
                  </button>
                  <button
                    type="button"
                    class="rounded-md border border-slate-700 bg-slate-900 px-3 py-2 text-sm text-slate-200 hover:bg-slate-800 transition"
                    :disabled="disableNext"
                    @click="nextPage"
                  >
                    Siguiente
                  </button>
                </div>
              </div>

              <div class="rounded-xl border border-slate-800 bg-slate-900/60 shadow-inner">
                <div class="border-b border-slate-800 px-5 py-3 text-sm font-semibold text-slate-200">Resultados</div>
                <p class="px-5 pt-3 text-xs text-slate-400">Vista por defecto: listado JSON de los primeros documentos de la colección seleccionada.</p>
                <div class="p-5 space-y-4">
                  <div v-if="queryLoading" class="text-sm text-slate-400">Ejecutando consulta…</div>
                  <div v-else-if="queryError" class="text-sm text-rose-400">{{ queryError }}</div>
                  <div v-else-if="queryRows.length === 0" class="text-sm text-slate-400">No se encontraron documentos.</div>
                  <div v-else class="space-y-4">
                    <div
                      v-for="(row, idx) in queryRows"
                      :key="idx"
                      class="rounded-lg border border-slate-800 bg-slate-950 p-4"
                    >
                      <div class="flex items-center justify-between text-xs text-slate-500 mb-3">
                        <span>Documento #{{ offset + idx + 1 }}</span>
                        <button
                          v-if="canDeleteRow(row)"
                          type="button"
                          class="rounded-md border border-rose-500/40 bg-rose-600/20 px-2 py-1 text-xs font-semibold text-rose-200 hover:bg-rose-600/30 transition"
                          @click="deleteRow(row)"
                        >
                          Eliminar
                        </button>
                      </div>
                      <pre class="whitespace-pre-wrap break-words text-sm text-slate-200 font-mono">{{ formatDocument(row) }}</pre>
                      <p v-if="!canDeleteRow(row) && activeIndex && activeIndex.type === 'map'" class="mt-3 text-xs text-slate-500">
                        El documento no contiene el campo «{{ activeIndex.field }}» requerido para eliminarlo.
                      </p>
                      <p v-else-if="activeIndex && activeIndex.type !== 'map'" class="mt-3 text-xs text-slate-500">
                        Selecciona un índice de tipo "map" para habilitar la eliminación directa.
                      </p>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="space-y-6">
              <div class="rounded-xl border border-slate-800 bg-slate-900/60 p-5 shadow-inner space-y-4">
                <h3 class="text-sm font-semibold text-slate-200 uppercase tracking-wide">Insertar documento</h3>
                <textarea
                  v-model="insertForm.payload"
                  rows="8"
                  class="w-full rounded-lg border border-slate-700 bg-slate-950 px-3 py-2 text-sm font-mono text-slate-200 focus:outline-none focus:ring-2 focus:ring-sky-500"
                  placeholder='{"name": "Ada"}'
                ></textarea>
                <div class="flex justify-end">
                  <button
                    type="button"
                    class="rounded-md bg-sky-600 px-4 py-2 text-sm font-semibold text-white hover:bg-sky-500 transition"
                    @click="insertDocument"
                  >
                    Insertar
                  </button>
                </div>
                <p v-if="insertForm.error" class="text-sm text-rose-400">{{ insertForm.error }}</p>
                <p v-else-if="insertForm.success" class="text-sm text-emerald-400">{{ insertForm.success }}</p>
              </div>

              <div class="rounded-xl border border-slate-800 bg-slate-900/60 p-5 shadow-inner space-y-4">
                <h3 class="text-sm font-semibold text-slate-200 uppercase tracking-wide">Índices</h3>
                <div v-if="indexesLoading" class="text-sm text-slate-400">Cargando índices…</div>
                <div v-else-if="indexes.length === 0" class="text-sm text-slate-400">La colección no tiene índices definidos.</div>
                <ul v-else class="space-y-3 text-sm text-slate-300">
                  <li v-for="index in indexes" :key="index.name" class="rounded-lg border border-slate-800 bg-slate-950 p-3">
                    <div class="flex items-center justify-between">
                      <span class="font-semibold">{{ index.name }}</span>
                      <span class="text-xs uppercase tracking-wide text-slate-500">{{ index.type }}</span>
                    </div>
                    <p v-if="index.type === 'map'" class="mt-1 text-xs text-slate-400">Campo: {{ index.field }}</p>
                    <p v-else-if="index.type === 'btree'" class="mt-1 text-xs text-slate-400">Campos: {{ index.fields.join(', ') }}</p>
                    <p v-if="index.unique" class="mt-1 text-xs text-emerald-400">Único</p>
                    <p v-if="index.sparse" class="mt-1 text-xs text-slate-500">Sparse</p>
                  </li>
                </ul>
              </div>
            </div>
          </section>
        </div>
      </main>
    </div>

    <script>
      const { createApp, ref, reactive, computed, watch, onMounted } = Vue;

      createApp({
        setup() {
          const collections = ref([]);
          const collectionsLoading = ref(false);
          const collectionsError = ref('');
          const selectedCollectionName = ref('');
          const indexes = ref([]);
          const indexesLoading = ref(false);
          const filterText = ref('{\n\n}');
          const filterError = ref('');
          const page = ref(1);
          const pageSize = ref(25);
          const pageSizeOptions = [10, 25, 50, 100];
          const queryRows = ref([]);
          const queryLoading = ref(false);
          const queryError = ref('');
          const queryStats = reactive({ elapsed: '', returned: 0 });
          const selectedIndexName = ref('');
          const mapValue = ref('');
          const reverse = ref(false);
          const rangeFrom = reactive({});
          const rangeTo = reactive({});
          const insertForm = reactive({ payload: '{\n\n}', error: '', success: '' });
          const createForm = reactive({ open: false, name: '', error: '' });

          const selectedCollection = computed(() => collections.value.find(c => c.name === selectedCollectionName.value) || null);
          const activeIndex = computed(() => indexes.value.find(idx => idx.name === selectedIndexName.value) || null);
          const offset = computed(() => Math.max(0, (Number(page.value) - 1) * Number(pageSize.value || 0)));
          const disablePrev = computed(() => page.value <= 1);
          const disableNext = computed(() => {
            const limit = Number(pageSize.value) || 0;
            if (limit === 0) return true;
            return queryRows.value.length < limit;
          });
          const pageInfo = computed(() => {
            const count = queryRows.value.length;
            if (count === 0) {
              return 'Sin resultados en esta página.';
            }
            const start = offset.value + 1;
            const end = offset.value + count;
            const total = selectedCollection.value?.total;
            if (typeof total === 'number') {
              return `Mostrando ${start}–${end} de ${total}`;
            }
            return `Mostrando ${start}–${end}`;
          });

          const prettyTotal = (n) => {
            if (typeof n !== 'number') return n;
            if (n >= 1_000_000) return (n / 1_000_000).toFixed(1).replace(/\.0$/, '') + 'M';
            if (n >= 1_000) return (n / 1_000).toFixed(1).replace(/\.0$/, '') + 'K';
            return n;
          };

          const isSelected = (name) => selectedCollectionName.value === name;

          const toggleCreateForm = () => {
            createForm.open = !createForm.open;
            createForm.error = '';
          };

          const selectCollection = (name) => {
            if (selectedCollectionName.value === name) {
              selectedCollectionName.value = '';
            } else {
              selectedCollectionName.value = name;
            }
          };

          const resetRangeFields = () => {
            Object.keys(rangeFrom).forEach((key) => delete rangeFrom[key]);
            Object.keys(rangeTo).forEach((key) => delete rangeTo[key]);
            const index = activeIndex.value;
            if (index && index.type === 'btree') {
              (index.fields || []).forEach((field) => {
                rangeFrom[field] = '';
                rangeTo[field] = '';
              });
            }
          };

          watch(activeIndex, () => {
            mapValue.value = '';
            reverse.value = false;
            resetRangeFields();
          });

          watch(selectedCollection, async (collection) => {
            indexes.value = [];
            selectedIndexName.value = '';
            mapValue.value = '';
            reverse.value = false;
            resetRangeFields();
            filterText.value = '{\n\n}';
            filterError.value = '';
            page.value = 1;
            queryRows.value = [];
            queryError.value = '';
            queryStats.elapsed = '';
            queryStats.returned = 0;
            if (collection) {
              await loadIndexes();
              await runQuery();
            }
          });

          const loadCollections = async () => {
            collectionsLoading.value = true;
            collectionsError.value = '';
            try {
              const resp = await axios.get('/v1/collections');
              const list = Array.isArray(resp.data) ? resp.data.slice() : [];
              list.sort((a, b) => a.name.localeCompare(b.name));
              collections.value = list;
              if (selectedCollectionName.value) {
                const exists = list.some((item) => item.name === selectedCollectionName.value);
                if (!exists) {
                  selectedCollectionName.value = '';
                }
              }
            } catch (error) {
              collectionsError.value = error?.response?.data?.error || 'No se pudieron cargar las colecciones.';
            } finally {
              collectionsLoading.value = false;
            }
          };

          const loadIndexes = async () => {
            if (!selectedCollection.value) return;
            indexesLoading.value = true;
            try {
              const resp = await axios.post(`/v1/collections/${encodeURIComponent(selectedCollection.value.name)}:listIndexes`);
              const list = Array.isArray(resp.data) ? resp.data : [];
              indexes.value = list;
              if (!list.some((idx) => idx.name === selectedIndexName.value)) {
                selectedIndexName.value = '';
              }
            } catch (error) {
              indexes.value = [];
            } finally {
              indexesLoading.value = false;
            }
          };

          const parseFilter = () => {
            const raw = filterText.value.trim();
            if (!raw) {
              filterText.value = '{}';
              return {};
            }
            try {
              const parsed = JSON.parse(raw);
              filterError.value = '';
              return parsed;
            } catch (err) {
              filterError.value = 'JSON inválido: ' + err.message;
              return null;
            }
          };

          const buildQueryPayload = () => {
            const parsedFilter = parseFilter();
            if (parsedFilter === null) {
              const error = new Error('invalid-filter');
              error.code = 'invalid-filter';
              throw error;
            }
            const payload = {
              filter: parsedFilter,
              limit: Number(pageSize.value) || 0,
              skip: offset.value,
            };
            const index = activeIndex.value;
            if (index) {
              payload.index = index.name;
              if (index.type === 'map') {
                if (!mapValue.value) {
                  const error = new Error('map-value-required');
                  error.code = 'map-value-required';
                  throw error;
                }
                payload.value = mapValue.value;
              } else if (index.type === 'btree') {
                payload.reverse = !!reverse.value;
                const fields = index.fields || [];
                if (fields.length && fields.every((field) => rangeFrom[field])) {
                  const from = {};
                  fields.forEach((field) => {
                    from[field] = rangeFrom[field];
                  });
                  payload.from = from;
                }
                if (fields.length && fields.every((field) => rangeTo[field])) {
                  const to = {};
                  fields.forEach((field) => {
                    to[field] = rangeTo[field];
                  });
                  payload.to = to;
                }
              }
            }
            return payload;
          };

          const runQuery = async () => {
            if (!selectedCollection.value) return;
            queryError.value = '';
            let payload;
            try {
              payload = buildQueryPayload();
            } catch (error) {
              if (error.code === 'invalid-filter') {
                queryError.value = 'El filtro debe ser un JSON válido.';
              } else if (error.code === 'map-value-required') {
                queryError.value = 'Debes indicar un valor para el índice seleccionado.';
              } else {
                queryError.value = error.message || 'No se pudo preparar la consulta.';
              }
              return;
            }
            queryLoading.value = true;
            const started = performance.now();
            try {
              const resp = await axios({
                method: 'post',
                url: `/v1/collections/${encodeURIComponent(selectedCollection.value.name)}:find`,
                data: payload,
                transformResponse: (res) => res,
                responseType: 'text',
              });
              const raw = resp.data || '';
              const lines = raw.split('\n').filter(Boolean);
              const parsedRows = lines.map((line) => {
                try {
                  return JSON.parse(line);
                } catch (err) {
                  return { _raw: line };
                }
              });
              queryRows.value = parsedRows;
              queryStats.returned = parsedRows.length;
              const elapsed = Math.round(performance.now() - started);
              queryStats.elapsed = `${elapsed} ms`;
            } catch (error) {
              queryError.value = error?.response?.data?.error || 'No se pudo obtener la colección.';
            } finally {
              queryLoading.value = false;
            }
          };

          const nextPage = () => {
            if (disableNext.value) return;
            page.value = Number(page.value) + 1;
            runQuery();
          };

          const prevPage = () => {
            if (disablePrev.value) return;
            page.value = Math.max(1, Number(page.value) - 1);
            runQuery();
          };

          watch(pageSize, (value, old) => {
            if (value === old) return;
            page.value = 1;
            runQuery();
          });

          const canDeleteRow = (row) => {
            const index = activeIndex.value;
            if (!index || index.type !== 'map') return false;
            const field = index.field;
            if (!field) return false;
            return Object.prototype.hasOwnProperty.call(row, field);
          };

          const deleteRow = async (row) => {
            const index = activeIndex.value;
            if (!selectedCollection.value || !index || index.type !== 'map' || !index.field) return;
            const value = row[index.field];
            if (value === undefined) {
              queryError.value = `El documento no contiene el campo «${index.field}».`;
              return;
            }
            const ok = window.confirm(`¿Eliminar el documento donde ${index.field} = ${value}?`);
            if (!ok) return;
            try {
              await axios.post(`/v1/collections/${encodeURIComponent(selectedCollection.value.name)}:remove`, {
                mode: 'unique',
                field: index.field,
                value,
              });
              await runQuery();
              await loadCollections();
            } catch (error) {
              queryError.value = error?.response?.data?.error || 'No se pudo eliminar el documento.';
            }
          };

          const insertDocument = async () => {
            insertForm.error = '';
            insertForm.success = '';
            if (!selectedCollection.value) {
              insertForm.error = 'Selecciona una colección antes de insertar.';
              return;
            }
            let payload;
            try {
              payload = JSON.parse(insertForm.payload);
            } catch (err) {
              insertForm.error = 'JSON inválido: ' + err.message;
              return;
            }
            try {
              await axios.post(`/v1/collections/${encodeURIComponent(selectedCollection.value.name)}:insert`, payload);
              insertForm.success = 'Documento insertado correctamente.';
              insertForm.payload = '{\n\n}';
              await runQuery();
              await loadCollections();
            } catch (error) {
              insertForm.error = error?.response?.data?.error || 'No se pudo insertar el documento.';
            }
          };

          const createCollection = async () => {
            createForm.error = '';
            const name = createForm.name.trim();
            if (!name) {
              createForm.error = 'Indica un nombre para la colección.';
              return;
            }
            try {
              const resp = await axios.post('/v1/collections', { name });
              await loadCollections();
              const created = resp?.data?.name || name;
              selectedCollectionName.value = created;
              createForm.name = '';
              createForm.open = false;
            } catch (error) {
              createForm.error = error?.response?.data?.error || 'No se pudo crear la colección.';
            }
          };

          const dropCollection = async () => {
            if (!selectedCollection.value) return;
            const name = selectedCollection.value.name;
            const ok = window.confirm(`¿Eliminar la colección «${name}»? Esta acción no se puede deshacer.`);
            if (!ok) return;
            try {
              await axios.post(`/v1/collections/${encodeURIComponent(name)}:dropCollection`);
              selectedCollectionName.value = '';
              await loadCollections();
            } catch (error) {
              queryError.value = error?.response?.data?.error || 'No se pudo eliminar la colección.';
            }
          };

          const formatDocument = (row) => {
            if (row && typeof row === 'object' && '_raw' in row) {
              return row._raw;
            }
            try {
              return JSON.stringify(row, null, 2);
            } catch (err) {
              return String(row);
            }
          };

          onMounted(() => {
            loadCollections();
          });

          return {
            // state
            collections,
            collectionsLoading,
            collectionsError,
            selectedCollection,
            selectedCollectionName,
            indexes,
            indexesLoading,
            filterText,
            filterError,
            queryRows,
            queryLoading,
            queryError,
            queryStats,
            selectedIndexName,
            activeIndex,
            mapValue,
            reverse,
            rangeFrom,
            rangeTo,
            insertForm,
            createForm,
            disablePrev,
            disableNext,
            page,
            pageSize,
            pageSizeOptions,
            offset,
            pageInfo,
            // methods
            prettyTotal,
            isSelected,
            toggleCreateForm,
            selectCollection,
            runQuery,
            nextPage,
            prevPage,
            insertDocument,
            createCollection,
            dropCollection,
            deleteRow,
            canDeleteRow,
            formatDocument,
          };
        },
      }).mount('#app');
    </script>
  </body>
</html>
