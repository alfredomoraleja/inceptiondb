<!doctype html>
<html>
    <head>
        <meta charset="utf-8">
        <title>InceptionDB -  Î±lpha</title>
        <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0">
        <link rel="stylesheet" href="/lib/bootstrap.min.css">
        <link rel="stylesheet" href="style.css?a">
        <script src="/lib/axios.min.js"></script>
        <script src="/lib/vue.js"></script>
    </head>
    <body>
        <div id="app" :collection="collection_name">
            <div id="frame-top">
                <h1 style="padding: 8px 16px;">InceptionDB</h1>
            </div>
            <div id="frame-center">
                <div id="frame-left">
                    <h2 id="collectionsTitle">Collections</h2>
                    <ul id="collectionsList" style="margin: 0; padding: 0; list-style-type: none;">
                        <li
                            v-for="collection in collections"
                            class="list-group-item"
                            :class="{active: collection_name == collection}"
                            @click="selectCollection(collection.name); showPanel('fullscan'); fetchFullScan(collection.name);"
                        >
                            <div style="float: right; font-size: 12px;">
                                <span v-if="collection.indexes">ðŸ”‘ {{ collection.indexes }}</span>
                                <span :title="collection.total">ðŸ“ƒ {{ prettyTotal(collection.total) }}</span>
                            </div>
                            <h5 :title="collection" class="mb-1 text-truncate">{{ collection.name }}</h5>
                            <div class="line2" style="font-size: 90%;">
                                <a href="#" >Fullscan</a>
                                |
                                <a href="#" @click.prevent.stop="selectCollection(collection.name); showPanel('indexsearch'); fetchIndexes(collection);">IndexSearch</a>
                            </div>
                        </li>
                    </ul>
                    <br>
                    <div id="collectionsButtons" style="text-align: center;">
                        <button class="btn btn-primary" @click="create_collection.show = true">Create collection</button>
                    </div>
                </div>
                <div id="frame-right" v-if="collection_name">
                    <h2 id="collectionTitle">{{ collection_name }}</h2>

                    <div class="line2">
                        <a href="#" :class="{active: panels.fullscan}" @click.prevent.stop="showPanel('fullscan'); fetchFullScan(collection_name);">Fullscan</a>
                        |
                        <a href="#" :class="{active: panels.indexsearch}" @click.prevent.stop="showPanel('indexsearch'); fetchIndexes(collection_name);">IndexSearch</a>
                        |
                        <a href="#" :class="{active: panels.delete}"  @click.prevent.stop="showPanel('delete');">Drop collection</a>
                    </div>

                    <div v-if="panels.fullscan">
                        <div v-if="rows === null">loading...</div>
                        <div v-else-if="rows.length === 0">
                            <div class="alert alert-info" role="alert">
                                Result is empty, try inserting some rows.
                            </div>
                        </div>
                        <form @submit.prevent="fetchFullScan(collection_name)">
                            <div class="form-group">
                                <label for="fullscan-filter">Type filter in MongoDB style:</label>
                                <textarea class="form-control" v-model="full_scan.filter" id="fullscan-filter" rows="3" style="font-family: monospace;" @keyup="fullscanFilterKeyup()"></textarea>
                            </div>
                        </form>
                        <table class="table table-striped" >
                            <tr v-for="row in rows">
                                <td style="font-family: monospace;">{{ row }}</td>
                            </tr>
                        </table>
                        <div v-if="rows.length || full_scan.skip">
                            <form @submit.prevent="fetchFullScan(collection_name)" style="width: 460px; margin: 0 auto;">
                               <div class="input-group mb-3">
                                    <div class="input-group-prepend">
                                        <button
                                            :disabled="full_scan.skip==0"
                                            class="btn btn-secondary"
                                            type="button"
                                            @click="full_scan.skip -= full_scan.limit; if (full_scan.skip <0) {full_scan.skip=0}; fetchFullScan(collection_name);"
                                        >Previous</button>
                                    </div>
                                    <div class="input-group-prepend">
                                        <label class="input-group-text" for="fullscan-pagination-skip">skip</label>
                                    </div>
                                    <input
                                            type="number"
                                            class="form-control"
                                            id="fullscan-pagination-skip"
                                            v-model="full_scan.skip"
                                            @keyup="fetchFullScan(collection_name)"
                                            min="0"
                                    >
                                    <div class="input-group-prepend">
                                        <label class="input-group-text" for="fullscan-pagination-limit">limit</label>
                                    </div>
                                    <input
                                            type="number"
                                            class="form-control"
                                            id="fullscan-pagination-limit"
                                            v-model="full_scan.limit"
                                            @keyup="fetchFullScan(collection_name)"
                                            min="0"
                                    >
                                    <div class="input-group-append">
                                        <button
                                            :disabled="rows.length < full_scan.limit"
                                            class="btn btn-secondary"
                                            type="button"
                                            @click="full_scan.skip += parseInt(full_scan.limit); fetchFullScan(collection_name);"
                                        >Next</button>
                                    </div>
                                </div>
                            </form>
                        </div>
                        <div class="examples">
                            <div class="examples_client_selector">
                                <span
                                    v-for="client in examples.clients"
                                    :class="{active: client == examples.client}"
                                    @click="examples.client = client"
                                >[{{client}}]</span>
                            </div>
                            <div class="code" v-if="examples.client=='curl'">
                                <code>curl '{{base_url}}/v1/collections/{{collection_name}}:find' -d '{{  {mode:'fullscan', limit: full_scan.limit, skip: full_scan.skip, filter: JSON.parse(full_scan.filter) } }}'</code>
                            </div>
                            <div class="code" v-else-if="examples.client=='js'">
                                <code>fetch('{{base_url}}/v1/collections/{{collection_name}}:find', {method: 'POST'})
    .then(response => response.json())
    .then(data => console.log(data));</code>
                            </div>
                            <div class="code" v-else>
                                <code>// No sample available at this moment</code>
                                You can contribute at <a href="https://github.com/fulldump/inceptiondb">https://github.com/fulldump/inceptiondb</a>
                            </div>
                        </div>
                        <br>
                        <br>
                        <h2>Insert</h2>
                        <form @submit.prevent="insertItemSubmit">
                            <div class="form-group">
                                <label for="insertPayload">Type the document you want to insert in JSON:</label>
                                <textarea class="form-control" v-model="insert_item.request.payload" id="insertPayload" rows="3" style="font-family: monospace;"></textarea>
                            </div>
                            <div style="text-align: center;">
                                <button class="btn btn-primary" type="submit">Insert item</button>
                            </div>
                            <div v-if="insert_item.error" class="alert alert-danger" role="alert" style="margin-top: 16px;">{{ insert_item.error }}</div>
                        </form>
                        <br>
                        <div class="examples">
                            <div class="examples_client_selector">
                                <span
                                    v-for="client in examples.clients"
                                    :class="{active: client == examples.client}"
                                    @click="examples.client = client"
                                >[{{client}}]</span>
                            </div>
                            <div class="code" v-if="examples.client=='curl'">
                                <code>curl {{base_url}}/v1/collections/{{collection_name}} -d '{{ JSON.parse(insert_item.request.payload) }}'</code>
                            </div>
                            <div class="code" v-else-if="examples.client=='js'">
                                <code>fetch('{{base_url}}/v1/collections/{{collection_name}}')
                                    .then(response => response.json())
                                    .then(data => console.log(data));</code>
                            </div>
                            <div class="code" v-else>
                                <code>// No sample available at this moment</code>
                                You can contribute at <a href="https://github.com/fulldump/inceptiondb">https://github.com/fulldump/inceptiondb</a>
                            </div>
                        </div>
                    </div>

                    <div v-if="panels.indexsearch">
                        Find by index
                        <select v-model="find_by_index" @change="find_by_value=''">
                            <option v-for="index in indexes" :value="index.name">{{index.name}}</option>
                        </select>
                        :
                        <input type="text" v-model="find_by_value" @keyup="findByIndex(collection_name, find_by_index, find_by_value)"> <br>
                        <div v-if="find_by_error" class="alert alert-danger" role="alert" style="margin-top: 16px;">{{find_by_error}}</div>
                        <pre v-if="item">{{ item }}</pre>
                        <button v-if="item" class="btn btn-primary" @click="findByIndex(collection_name, find_by_index, find_by_value)">Reload</button>
                        <br>
                        <br>
                        <div class="examples" v-if="item">
                            <div class="examples_client_selector">
                                <span
                                    v-for="client in examples.clients"
                                    :class="{active: client == examples.client}"
                                    @click="examples.client = client"
                                >[{{client}}]</span>
                            </div>
                            <div class="code" v-if="examples.client=='curl'">
                                <code>curl {{base_url}}/v1/collections/{{encodeURIComponent(collection_name)}}/index/{{encodeURIComponent(find_by_index)}}/findBy/{{encodeURIComponent(find_by_value)}}</code>
                            </div>
                            <div class="code" v-else-if="examples.client=='js'">
                                <code>fetch('{{base_url}}/v1/collections/{{encodeURIComponent(collection_name)}}/index/{{encodeURIComponent(find_by_index)}}/findBy/{{encodeURIComponent(find_by_value)}}')
    .then(response => response.json())
    .then(data => console.log(data));</code>
                            </div>
                            <div class="code" v-else>
                                <code>// No sample available at this moment</code>
                                You can contribute at <a href="https://github.com/fulldump/inceptiondb">https://github.com/fulldump/inceptiondb</a>
                            </div>
                        </div>

                        <div v-if="item">
                            <br><br>
                            <h2>Patch</h2>
                            <textarea style="width: 98%; height: 180px; font-family: monospace;" v-model="item_patch"></textarea>
                            <button class="btn btn-primary" @click="applyPatchClick()">Apply patch</button>
                            <br>
                            <br>
                            <div class="examples">
                                <div class="examples_client_selector">
                                <span
                                    v-for="client in examples.clients"
                                    :class="{active: client == examples.client}"
                                    @click="examples.client = client"
                                >[{{client}}]</span>
                                </div>
                                <div class="code" v-if="examples.client=='curl'">
                                    <code>curl {{base_url}}/v1/collections/{{encodeURIComponent(collection_name)}}:patch -X PATCH -d '{{ JSON.parse(this.item_patch) }}'</code>
                                </div>
                                <div class="code" v-else-if="examples.client=='js'">
                                    <code>fetch('{{base_url}}/v1/collections/{{encodeURIComponent(collection_name)}}:patch', {{ {"method":"PATCH", "body":JSON.parse(this.item_patch)} }})
    .then(response => response.json())
    .then(data => console.log(data));</code>
                                </div>
                                <div class="code" v-else>
                                    <code>// No sample available at this moment</code>
                                    You can contribute at <a href="https://github.com/fulldump/inceptiondb">https://github.com/fulldump/inceptiondb</a>
                                </div>
                            </div>

                            <br>
                            <br>
                            <h2>Delete</h2>
                            <div style="text-align: center;">
                                Press this button to delete the item <code>{{find_by_index}}="{{find_by_value}}"</code>
                                <br>
                                <br>
                                <button class="btn btn-danger" @click="deleteItemClick">Delete</button>
                            </div>

                            <br>
                            <div class="examples">
                                <div class="examples_client_selector">
                                <span
                                        v-for="client in examples.clients"
                                        :class="{active: client == examples.client}"
                                        @click="examples.client = client"
                                >[{{client}}]</span>
                                </div>
                                <div class="code" v-if="examples.client=='curl'">
                                    <code>curl {{base_url}}/v1/collections/{{encodeURIComponent(collection_name)}}/index/{{encodeURIComponent(find_by_index)}}/findBy/{{encodeURIComponent(find_by_value)}} -X DELETE</code>
                                </div>
                                <div class="code" v-else-if="examples.client=='js'">
                                    <code>fetch('{{base_url}}/v1/collections/{{encodeURIComponent(collection_name)}}/index/{{encodeURIComponent(find_by_index)}}/findBy/{{encodeURIComponent(find_by_value)}}', {{ {"method":"DELETE"} }})
                                        .then(response => response.json())
                                        .then(data => console.log(data));</code>
                                </div>
                                <div class="code" v-else>
                                    <code>// No sample available at this moment</code>
                                    You can contribute at <a href="https://github.com/fulldump/inceptiondb">https://github.com/fulldump/inceptiondb</a>
                                </div>
                            </div>

                        </div>
                        <br><br><br><br><br><br>
                    </div>

                    <div v-if="panels.delete" style="text-align: center;">
                        <br>
                        Press the following button to drop the collection <code>{{collection_name}}</code>: <br>
                        <br>
                        <button class="btn btn-danger" @click="deleteCollectionClick()">Drop</button>
                    </div>

                </div>
            </div>

            <div class="popup" v-if="create_collection.show">
                <div class="popup-window">
                    <div class="popup-decoration">
                        <form @submit.prevent="createCollectionSubmit">
                            <header>
                                <h1>Create collection</h1>
                            </header>
                            <section>
                                <div class="form-group">
                                    <label for="collection_name">Collection name</label>
                                    <input type="text" v-model="create_collection.request.payload.name" class="form-control" id="collection_name" placeholder="Enter collection name">
                                    <small id="collection_name_help" class="form-text text-muted">Just alphanumeric text.</small>
                                </div>
                                <div class="examples">
                                    <div class="examples_client_selector">
                                        <span
                                            v-for="client in examples.clients"
                                            :class="{active: client == examples.client}"
                                            @click="examples.client = client"
                                        >[{{client}}]</span>
                                    </div>
                                    <div class="code" v-if="examples.client=='curl'">
                                        <code>curl {{base_url}}/v1/collections -d '{{create_collection.request.payload}}' </code>
                                    </div>
                                    <div class="code" v-else-if="examples.client=='js'">
                                        <code>fetch('{{base_url}}/v1/collections', {{ {"method":"POST", "body":create_collection.request.payload} }})
    .then(response => response.json())
    .then(data => console.log(data));</code>
                                    </div>
                                    <div class="code" v-else>
                                        <code>// No sample available at this moment</code>
                                        You can contribute at <a href="https://github.com/fulldump/inceptiondb">https://github.com/fulldump/inceptiondb</a>
                                    </div>
                                </div>

                            </section>
                            <footer>
                                <button type="button" class="btn btn-secondary" @click="create_collection.show = false">Cancel</button>
                                <button type="submit" class="btn btn-primary">Create collection</button>
                            </footer>
                        </form>
                    </div>
                </div>
            </div>

        </div>

        <script>

            var app = new Vue({
                el: '#app',
                data: {
                    base_url: window.location.protocol + '//' + window.location.host,
                    examples: {
                        clients: ['curl', 'js', 'go'],
                        client: 'curl',
                    },
                    collection_name: "",
                    collections: [],
                    rows: [],
                    indexes: [],
                    find_by_value: '',
                    find_by_index: '',
                    find_by_error: '',
                    item: '',
                    panels: {
                        fullscan: false,
                        indexsearch: false,
                        delete: false,
                        insert: false,
                    },
                    item_patch: '{\n\n}',

                    // Operation create collection
                    create_collection: {
                        show: false,
                        request: {
                            payload: {
                                name: '',
                            },
                        },
                    },

                    // Operation insert item
                    insert_item: {
                        error: '',
                        request: {
                            payload: '{\n\n}',
                        },
                    },

                    // Operation full scan
                    full_scan: {
                        skip: 0,
                        limit: 10,
                        filter: '{\n\n}',
                        request: {
                            payload: {},
                        },
                    },
                },
                methods: {
                    listCollections() {
                        var that = this;
                        axios.get('/v1/collections')
                            .then(function(resp) {
                                that.collections = resp.data;
                            });
                    },
                    selectCollection(collection) {
                        this.rows = [];
                        this.indexes = [];
                        this.collection_name = (this.collection_name == collection) ? '' : collection;
                        this.full_scan.skip = 0;
                        this.full_scan.filter = '{\n\n}';
                    },
                    findByIndex(collection, index, value) {
                        var that = this;
                        that.find_by_error = '';
                        axios({
                            method: 'POST',
                            url: '/v1/collections/'+ encodeURIComponent(collection) + ':find',
                            data: {
                                mode: "unique",
                                index: index,
                                value: value,
                            }
                        })
                            .then(function(resp) {
                                that.item = resp.data;
                                if (resp.data == '') {
                                    that.find_by_error = `No match for ${value}`
                                }
                            })
                            .catch(function (error) {
                                that.item = '';
                                if (error.response) {
                                    that.find_by_error = error.response.data.error;
                                    return
                                }
                                that.find_by_error = 'Network error';
                            });
                    },
                    createCollectionSubmit() {
                        // this.showPanel('');
                        var that = this;
                        axios.post('/v1/collections', this.create_collection.request.payload)
                            .then(function(resp) {
                                console.log('createcollectionresp', resp);
                                var newCollection = resp.data;
                                that.collections.push(newCollection);
                                that.selectCollection(newCollection.name);
                                that.create_collection.show = false;
                                that.showPanel('fullscan');
                            })
                            .catch(function(error) {
                                // TODO: put this error somewhere
                                if (!error.response) return;
                                alert(error.response.data.error);
                            });
                    },
                    insertItemSubmit() {
                        var payloadJson = JSON.parse(this.insert_item.request.payload);
                        this.insertItem(this.collection_name, payloadJson)
                    },
                    insertItem(collection, payload) {
                        var that = this;
                        axios.post('/v1/collections/'+ encodeURIComponent(collection)+':insert', payload)
                            .then(function(resp) {
                                that.insert_item.error = '';
                                that.rows.push(JSON.stringify(payload));
                                that.insert_item.request.payload = '{\n\n}';
                            })
                            .catch(function(error) {
                                if (!error.response) {
                                    that.insert_item.error = 'network error';
                                    return
                                }
                                that.insert_item.error = error.response.data.error;
                            });
                    },
                    createCollectionClick() {
                        this.create_collection.show = true;
                    },
                    deleteCollectionClick() { // Todo: rename to dropCollection
                        collection = this.collection_name;
                        var ok = confirm("Collection '"+collection+"' will be deleted, continue?");
                        if (!ok) return;
                        this.deleteCollection(collection)
                    },
                    deleteCollection(collection) { // Todo: rename to dropCollection
                        var that = this;
                        axios.post('/v1/collections/'+ encodeURIComponent(collection)+':dropCollection')
                            .then(function(resp) {
                                that.collection_name = '';
                                that.collections.splice(that.collections.indexOf(collection), 1);
                            });
                    },
                    showPanel(panel) {
                        for (var key in this.panels) {
                            this.panels[key] = key == panel;
                        }
                    },
                    fetchFullScanExperimental(collection) {
                        var that = this;
                        that.rows = [];
                        const fileURL = '/v1/collections/'+ encodeURIComponent(collection) + ':find';
                        const utf8Decoder = new TextDecoder("utf-8");
                        fetch(fileURL).then(response => {
                            let re = /\r\n|\n|\r/gm;
                            let startIndex = 0;
                            let reader = response.body.getReader();


                            var readCallback = function({value, done}) {
                                chunk = value
                                chunk = chunk ? utf8Decoder.decode(chunk, {stream: true}) : "";
                                for (;;) {
                                    let result = re.exec(chunk);
                                    if (!result) {
                                        if (done) {
                                            break;
                                        }
                                        let remainder = chunk.substr(startIndex);
                                        reader.read().then(readCallback);
                                        chunk = remainder + (chunk ? utf8Decoder.decode(chunk, {stream: true}) : "");
                                        startIndex = re.lastIndex = 0;
                                        continue;
                                    }
                                    var line = chunk.substring(startIndex, result.index);
                                    that.rows.push(line)
                                    console.log(line);
                                    startIndex = re.lastIndex;
                                }
                                if (startIndex < chunk.length) {
                                    // last line didn't end in a newline char
                                    console.log(chunk.substr(startIndex));
                                }

                            }

                            reader.read().then(readCallback);

                        });
                    },
                    fetchFullScan(collection) {
                        let that = this;
                        let payload = {
                            mode: "fullscan",
                            filter: {},
                            limit: parseInt(that.full_scan.limit),
                            skip: that.full_scan.skip,
                        };

                        try {
                            payload.filter = JSON.parse(that.full_scan.filter);
                        } catch (e) {
                            console.log(e)
                            // Nothing happen :D
                        }

                        axios({
                            method: 'post',
                            url: '/v1/collections/'+ encodeURIComponent(collection)+':find',
                            data: payload,
                            transformResponse: (res) => {return res;},
                            responseType: 'text',
                        })
                            .then(function(resp) {
                                var rows = [];
                                resp.data.split("\n").forEach(function(line) {
                                    if (line == '') return;
                                    rows.push(line);
                                });
                                that.rows = rows;
                            });
                    },
                    fullscanFilterKeyup() {
                        try {
                            JSON.parse(this.full_scan.filter)
                            this.fetchFullScan(this.collection_name);
                        } catch (e) {
                        }
                    },
                    fetchIndexes(collection) {
                        var that = this;
                        axios.post('/v1/collections/'+ encodeURIComponent(collection) + ":listIndexes")
                            .then(function(resp) {
                                that.indexes = resp.data;
                            });
                    },
                    applyPatchClick() {
                        var patchJson = JSON.parse(this.item_patch);
                        this.applyPatch(this.collection_name, this.find_by_index, this.find_by_value, patchJson)
                    },
                    applyPatch(collection, key, value, patch) {
                        var that = this;
                        let payload = {
                            "mode": "unique",
                            "field": key,
                            "value": value,
                            "patch": patch,
                        };
                        axios.post('/v1/collections/'+ encodeURIComponent(collection) + ':patch', payload)
                            .then(function(resp) {
                                that.item = resp.data;
                                that.item_patch = '{\n\n}';
                            });
                    },
                    deleteItemClick() {
                        var that = this;
                        let payload = {
                            "mode": "unique",
                            "field": that.find_by_index,
                            "value": that.find_by_value,
                        };
                        axios.post('/v1/collections/'+ encodeURIComponent(that.collection_name) + ':remove', payload)
                            .then(function(resp) {
                                that.item = null;
                                that.find_by_value = '';
                            });
                    },
                    prettyTotal(n) {
                        if (n > 1000000) {
                            return (n/1000000).toFixed(0) + 'M';
                        }
                        if (n > 1000) {
                            return (n/1000).toFixed(0) + 'K';
                        }
                        return n
                    },
            },
                beforeMount() {
                    this.listCollections();
                },

            });

        </script>

    </body>
</html>



